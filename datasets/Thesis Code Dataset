#R-code dataset
library(httr)
library(jsonlite)
library(readr)
library(readr)
library(dplyr)
library(lubridate)
library(stringr)

main_data <- read_csv("Main_Data.csv") #https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/U1EOXE
trust_data <- Trust #https://www.oecd.org/en/publications/society-at-a-glance-2024_918d8db3-en/full-report/trust-in-public-institutions_f4af755c.html filter 2020-2021
unemployment_data <- Unemployment_data #https://ec.europa.eu/eurostat/databrowser/view/une_rt_m__custom_16447558/default/table?lang=en

main_monthly <- main_data %>%
  group_by(country, year, Month) %>%
  summarise(
    protest_event_count = sum(Protests_count, na.rm = TRUE),
    riot_event_count = sum(Riots_count, na.rm = TRUE),
    workplace_closure = mean(C2_WorkplaceClosing, na.rm = TRUE),
    school_closure = mean(C1_SchoolClosing, na.rm = TRUE),
    gatherings_closure = mean(C4_RestrictionsGatherings, na.rm = TRUE),
    economic_support_index = mean(economicsupportindex, na.rm = TRUE),
    stringency_index = mean(stringencyindex, na.rm = TRUE),
    movement_index = mean(c(mean(C6_StayHomeRequirements, na.rm = TRUE),
                            mean(C7_RestricInternalMovement, na.rm = TRUE))),
    .groups = "drop"
  )

unemployment_clean <- unemployment_data %>%
  mutate(
    year = year(ymd(paste0(TIME_PERIOD, "-01"))),
    Month = month(ymd(paste0(TIME_PERIOD, "-01")))
  ) %>%
  rename(
    country = geo,
    unemployment = OBS_VALUE
  ) %>%
  select(country, year, Month, unemployment)

trust_filtered <- trust_data %>%
  filter(MEASURE == "14_3" & Measure == "Trust in government") %>%
  select(country = `Reference area`, year = TIME_PERIOD, trust_in_government = OBS_VALUE)

merged_data <- main_monthly %>%
  left_join(unemployment_clean, by = c("country", "year", "Month")) %>%
  left_join(trust_filtered, by = c("country", "year"))

write_csv(merged_data, "merged_monthly_data.csv")

print("Merged dataset:")
print(head(merged_data))
head(merged_data)

sapply(merged_data, function(x) sum(is.na(x)))


library(dplyr)

european_countries <- c(
  "Albania", "Andorra", "Armenia", "Austria", "Azerbaijan",
  "Belarus", "Belgium", "Bosnia and Herzegovina", "Bulgaria",
  "Croatia", "Cyprus", "Czech Republic", "Denmark", "Estonia",
  "Finland", "France", "Georgia", "Germany", "Greece", "Hungary",
  "Iceland", "Ireland", "Italy", "Kazakhstan", "Kosovo", "Latvia",
  "Liechtenstein", "Lithuania", "Luxembourg", "Malta", "Moldova",
  "Monaco", "Montenegro", "Netherlands", "North Macedonia", "Norway",
  "Poland", "Portugal", "Romania", "Russia", "San Marino", "Serbia",
  "Slovakia", "Slovenia", "Spain", "Sweden", "Switzerland", "Turkey",
  "Ukraine", "United Kingdom", "Vatican City"
)
merged_monthly_data <- merged_monthly_data %>%
  filter(country %in% european_countries)
data <- merged_monthly_data %>%
  mutate(total_event_count = protest_event_count + riot_event_count) %>%
  select(-protest_event_count, -riot_event_count, -country, -year, -Month) %>%
  na.omit()
